#include <stdio.h>
#include <time.h>
#include <string.h>
#include "../include/simplet.h"

#define ITERATIONS 10000

int main(void) {
    // Create dictionary with test data
    simplet_dictionary_t *dict = create_simplet_dictionary(SIZE_LARGE, true);
    if (!dict) {
        printf("Failed to create dictionary\n");
        return 1;
    }

    // Add test values
    simplet_dictionary_set(dict, "title", "Performance Test");
    simplet_dictionary_set(dict, "name", "John Doe");
    simplet_dictionary_set(dict, "date", "2025-09-29");
    simplet_dictionary_set(dict, "content", "This is a test of the simplet rendering engine with optimized C17 code.");

    // Test template with multiple substitutions
    const char *template =
        "<html>\n"
        "  <head><title>{{title}}</title></head>\n"
        "  <body>\n"
        "    <h1>Welcome {{name}}!</h1>\n"
        "    <p>Date: {{date}}</p>\n"
        "    <div>{{content}}</div>\n"
        "    <footer>Generated by {{engine}}</footer>\n"  // This key doesn't exist
        "  </body>\n"
        "</html>";

    printf("Running %d iterations of template rendering...\n", ITERATIONS);

    clock_t start = clock();

    for (int i = 0; i < ITERATIONS; i++) {
        char *result = simplet_render_html(template, dict);
        if (!result) {
            printf("Rendering failed on iteration %d\n", i);
            destroy_simplet_dictionary(dict);
            return 1;
        }
        free(result);
    }

    clock_t end = clock();
    double cpu_time_used = ((double) (end - start)) / CLOCKS_PER_SEC;

    printf("Completed %d iterations in %.3f seconds\n", ITERATIONS, cpu_time_used);
    printf("Average time per render: %.3f microseconds\n", (cpu_time_used * 1000000.0) / ITERATIONS);

    // Do one final render to show the output
    printf("\nSample output:\n");
    char *final = simplet_render_html(template, dict);
    if (final) {
        printf("%s\n", final);
        free(final);
    }

    destroy_simplet_dictionary(dict);
    return 0;
}